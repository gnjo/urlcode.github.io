<head>
 <script src="https://urlcode.github.io/thenload.js" type="text/javascript" ></script>
</head>
<body>
 <script type="text/javascript" >
 var fn=this.fn||{};
fn.g=(s)=>{return document.getElementById(s)};
fn.scrollend=(el)=>{
 return new Promise((sol)=>{
  var count=0;
  var me=function(){
   //console.log(count)
   if(count >10){ sol();return} //safecode
   if(el.scrollHeight - el.scrollTop >= el.clientHeight){ sol(); return}
   else{ window.scroll(0,el.scrollHeight+10) ;setTimeout(()=>{count++;me() },10) }
  };
   me();
 });
}

var css=`textarea,body{margin:0;padding:0;background-color:#111;color:#aaa}
body{margin-left:3rem}
#edit,#ret{width: calc(12/16*42rem);max-width: calc(12/16*42rem);padding-left:0.5rem}
#edit{position:fixed;top:1rem;right:1rem;height:90vh;}
#edit>textarea{border:0px solid;position:absolute;width:100%;height:100%;padding:0.5rem;
background-color:rgba(44,44,44,0.75);outline:none;
}

/**/
#edit,p{font-size: calc(12/16*1rem);margin:0;padding:0;}

h3{margin-bottom:0rem;padding-top:3rem}
h3{font-size:1rem}

sup{float:right;opacity:0.5;font-size:0.5rem}

.gazo{
background-blend-mode:darken;background-color:rgba(0,0,0,0.75);
background-size:cover;
background-position:50% 50%
}

p:after {/*改行*/
    content: '.';
    visibility: hidden;
}
`;

var T=thenload;
T([
 "https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css"
 ,css
 ,"https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"
 ,"https://urlcode.github.io/autosave.js"
]).then((d)=>{
 
 var I=T.initer;
 var layout=`<span><div id="ret"></div>
<div id="edit"><textarea id="t"></textarea></div></span>`;
 var el=I(layout,(el)=>{return el});
 document.body.appendChild(el);
 
 //////
 var A=autosave,da=fn.g('t')
 ,fdata=()=>{return da.value}
 ,id="xyz"
 ,olddata=A.load(id)
 ,time=10*1000
 ;
 if(olddata){
  da.value=olddata||'';
 }
 
 A((info)=>{
  var data=fdata(),flg=(info.md5 !== A.objectmd5(data));
  if(flg) return data;
 },time,id);

 window.addEventListener('keydown',(ev)=>{
  var flg=(ev.ctrlKey && ev.which ==='S'.charCodeAt(0));
  if(flg){ev.preventDefault(); A.save(id,fdata()); }
 });
window.addEventListener("beforeunload", (ev)=>{
   A.save(id,fdata());
});
///////

fn.md5=A.md5;
var markra=function(){};
markra.lex=function(str){
 markra.nowhash=null;//initialize
 var _str=str.split('\n').map((d)=>{
  var ck=d.charAt(0);
  if(markra._def[ck])return markra._def[ck](d);
  else return markra._def["para"](d);
 }).join('')
 return _str
}
markra.nowhash;
markra._def={
  "para":(str)=>{return '<p>'+str+'</p>'}
 ,"＃":(str)=>{
  markra.nowhash = markra.md5(str);
  var c= 'class="gazo hash-'+markra.nowhash+'"'
  return '<h3 '+c+'>'+str+'</h3>'
 }
 ,"＠":(str)=>{
  var a=str.slice(1).split('：');
  var ret='<sup>'+a[0]+'</sup>';
  if(a[0]){ 
   ret+='<style type="text/css">.hash-'+markra.nowhash+'{'
   +'background-image:url('+ a[1] +')}</style>';
  }
  return ret
 }
 ,"；":(str)=>{
  return '<!-- '+str+' -->';
 }
};
markra.def=function(opt){
 return Object.assign(markra._def,opt)
}
markra.md5=fn.md5;

var ret=fn.g('ret'),Mr=markra;
da.oninput=_.debounce((ev)=>{
  ret.innerHTML=Mr.lex( da.value );
  fn.scrollend(document.body);
},400);

 
////
if(olddata){
 ret.innerHTML=Mr.lex(da.value)
}

//////
});//end thenload
 </script>
</body>
